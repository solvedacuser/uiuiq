<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>온통청년 API 관리자 페이지</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- 사이드바 -->
            <nav class="col-md-3 col-lg-2 d-md-block bg-light sidebar">
                <div class="position-sticky pt-3">
                    <h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-muted">
                        <span>관리 메뉴</span>
                    </h6>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" th:href="@{/youth-policy/list}">
                                <i class="fas fa-list"></i> 정책 목록
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" th:href="@{/youth-policy/new}">
                                <i class="fas fa-plus"></i> 정책 등록
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" th:href="@{/youth-policy/admin}">
                                <i class="fas fa-cog"></i> 온통청년 API 관리
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- 메인 컨텐츠 -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">온통청년 API 데이터 관리</h1>
                    <div class="btn-toolbar mb-2 mb-md-0">
                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="refreshStatus()">
                            <i class="fas fa-sync-alt"></i> 상태 새로고침
                        </button>
                    </div>
                </div>

                <!-- 성공/오류 메시지 -->
                <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show" role="alert">
                    <i class="fas fa-check-circle"></i> <span th:text="${successMessage}"></span>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>

                <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show" role="alert">
                    <i class="fas fa-exclamation-triangle"></i> <span th:text="${errorMessage}"></span>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>

                <!-- API 키 설정 안내 -->
                <div class="alert alert-info" role="alert">
                    <h5 class="alert-heading"><i class="fas fa-key"></i> API 키 설정 확인</h5>
                    <p>온통청년 API를 사용하려면 <code>application.properties</code> 파일에서 API 키를 설정해야 합니다:</p>
                    <pre class="mb-0"><code>ontong.youth.api.key=YOUR_ACTUAL_API_KEY</code></pre>
                    <hr>
                    <p class="mb-0">API 키는 <a href="https://www.youthcenter.go.kr/myPage/openapi" target="_blank">온통청년 OPEN API 페이지</a>에서 발급받을 수 있습니다.</p>
                </div>

                <!-- 데이터베이스 상태 -->
                <div class="row mb-4">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0">
                                    <i class="fas fa-database"></i> 데이터베이스 상태
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-3">
                                        <div class="card bg-primary text-white">
                                            <div class="card-body text-center">
                                                <h3 th:text="${dbStatus.totalPolicies}">0</h3>
                                                <p class="mb-0">전체 정책</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card bg-success text-white">
                                            <div class="card-body text-center">
                                                <h3 th:text="${dbStatus.activePolicies}">0</h3>
                                                <p class="mb-0">활성 정책</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="card">
                                            <div class="card-body">
                                                <h6>카테고리별 통계</h6>
                                                <div th:if="${dbStatus.categoryStatistics != null}">
                                                    <div th:each="entry : ${dbStatus.categoryStatistics}" class="d-flex justify-content-between">
                                                        <span th:text="${entry.key}">카테고리</span>
                                                        <span class="badge bg-secondary" th:text="${entry.value}">0</span>
                                                    </div>
                                                </div>
                                                <div th:if="${dbStatus.categoryStatistics == null}" class="text-muted">
                                                    데이터가 없습니다.
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="mt-3">
                                    <small class="text-muted">
                                        <i class="fas fa-clock"></i> 
                                        마지막 업데이트: <span th:text="${#temporals.format(dbStatus.lastUpdated, 'yyyy-MM-dd HH:mm:ss')}"></span>
                                    </small>
                                    <br>
                                    <small class="text-info">
                                        <i class="fas fa-source"></i> 
                                        데이터 소스: <span th:text="${dbStatus.dataSource}">온통청년 API</span>
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- API 데이터 로드 -->
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0">
                                    <i class="fas fa-download"></i> 온통청년 API 데이터 로드
                                </h5>
                            </div>
                            <div class="card-body">
                                <p class="card-text">
                                    온통청년 공공 API에서 최신 청년정책 데이터를 가져와서 기존 데이터에 추가합니다.
                                </p>
                                <form th:action="@{/youth-policy/admin/load-api-data}" method="post" onsubmit="return confirmLoad()">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-download"></i> API 데이터 로드
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0 text-danger">
                                    <i class="fas fa-refresh"></i> 데이터 초기화 & 새로 로드
                                </h5>
                            </div>
                            <div class="card-body">
                                <p class="card-text">
                                    <strong class="text-danger">주의:</strong> 기존 데이터를 모두 삭제하고 온통청년 API에서 새로운 데이터를 가져옵니다.
                                </p>
                                <form th:action="@{/youth-policy/admin/refresh-all-data}" method="post" onsubmit="return confirmRefresh()">
                                    <button type="submit" class="btn btn-danger">
                                        <i class="fas fa-refresh"></i> 전체 데이터 초기화
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- API 정보 -->
                <div class="row mt-4">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0">
                                    <i class="fas fa-info-circle"></i> 온통청년 API 정보
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6>사용 중인 API</h6>
                                        <ul class="list-unstyled">
                                            <li><strong>온통청년 OPEN API</strong></li>
                                            <li>URL: https://www.youthcenter.go.kr/go/ythip/getPlcy</li>
                                            <li>타입: 공공 데이터 (API 키 필요)</li>
                                            <li>제공: 청년정책조정위원회</li>
                                        </ul>
                                    </div>
                                    <div class="col-md-6">
                                        <h6>데이터 특징</h6>
                                        <ul class="list-unstyled">
                                            <li>• 실시간 청년정책 정보</li>
                                            <li>• 카테고리별 분류 (일자리, 주거, 교육, 복지·문화, 참여·권리, 창업)</li>
                                            <li>• 신청기간, 대상연령, 지원내용 포함</li>
                                            <li>• API 오류 시 폴백 데이터 제공</li>
                                        </ul>
                                    </div>
                                </div>
                                <div class="mt-3 p-3 bg-light rounded">
                                    <h6>API 키 발급 방법:</h6>
                                    <ol class="mb-0">
                                        <li><a href="https://www.youthcenter.go.kr" target="_blank">온통청년 홈페이지</a> 회원가입</li>
                                        <li><a href="https://www.youthcenter.go.kr/myPage/openapi" target="_blank">OPEN API 페이지</a>에서 API 키 신청</li>
                                        <li>발급받은 API 키를 <code>application.properties</code>에 설정</li>
                                        <li>애플리케이션 재시작 후 데이터 로드</li>
                                    </ol>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function confirmLoad() {
            return confirm('온통청년 API에서 새로운 데이터를 로드하시겠습니까?\n\n기존 데이터는 유지되고 새로운 데이터가 추가됩니다.');
        }

        function confirmRefresh() {
            return confirm('⚠️ 경고: 모든 기존 데이터가 삭제됩니다!\n\n정말로 데이터베이스를 초기화하고 온통청년 API에서 새로운 데이터를 로드하시겠습니까?');
        }

        function refreshStatus() {
            fetch('/youth-policy/admin/status')
                .then(response => response.json())
                .then(data => {
                    console.log('상태 업데이트:', data);
                    location.reload();
                })
                .catch(error => {
                    console.error('상태 새로고침 중 오류:', error);
                    alert('상태 새로고침 중 오류가 발생했습니다.');
                });
        }

        // 페이지 로드 시 API 키 설정 확인
        document.addEventListener('DOMContentLoaded', function() {
            // 실제 환경에서는 서버에서 API 키 설정 여부를 확인하여 알림 표시
            console.log('온통청년 API 관리자 페이지 로드 완료');
        });
    </script>
</body>
</html>
